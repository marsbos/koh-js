var x=r=>(e,t)=>{let s=r._findEl(e,"hide");r.subscribe(t,o=>{s.hidden=!!o})};var y=r=>(e,{stream:t,key:s,tpl:o,render:i})=>{let n=r._findEl(e,"foreach"),c=new Map;r.subscribe(t,l=>{if(!Array.isArray(l))return;let m=new Set(l.map(a=>s(a)));for(let[a,p]of c)m.has(a)||(p.remove(),c.delete(a));let f=n.firstChild;l.forEach(a=>{let p=s(a),h=c.get(p);if(!h){if(i)h=i(a);else if(o){let d=n.querySelector(o).cloneNode(!0);d.removeAttribute("data-template"),d.removeAttribute("hidden"),d.setData(a),h=d}h||r._throwError("foreach","could not create node"),c.set(p,h)}(!h.isConnected||h!==f)&&n.insertBefore(h,f),f=h.nextSibling})})};var w=r=>(e,t,s)=>{let o=r._findEl(e,"on");o.addEventListener(t,s),r._onDispose(()=>o.removeEventListener(t,s))};var E=r=>(e,t)=>{let s=r._findEl(e,"show");r.subscribe(t,o=>{s.hidden=!o})};var _=r=>(e,t,s="textContent")=>{let o=r._findEl(e,"sync");r.subscribe(t,i=>{if(typeof s=="function"){let n=s(o,i);n&&typeof n=="object"&&Object.entries(n).forEach(([c,l])=>o[c]=l)}else o[s]=i},!0)};var g=r=>({foreach:y(r),hide:x(r),on:w(r),show:E(r),sync:_(r)});var b=class extends HTMLElement{constructor(e){super(),this.islandModule=e,this._mounted=!1,this._disposers=[],this._delegated={}}_dispose(){for(let e of this._disposers)e?.();this._disposers=[]}_onDispose(e){this._disposers.push(e)}_throwError(e,t){throw new Error(`[k.${e}] on <${this.tagName.toLowerCase()}>: ${t}`)}_findEl(e,t){let s=this.qs(e);return s||this._throwError(t,`${e} not found!`),s}qs(e,t=this){return typeof e=="string"?t.querySelector(e):e}qsa(e,t=this){return[...t.querySelectorAll(e)]}subscribe(e,t,s=!1){if(!("subscribe"in e))throw new Error("argument is not a Stream instance!");let o=e.subscribe(t,s);return this._onDispose(o),o}island(e){}setData(e){return this.initialData=e,this}connectedCallback(){this._mounted||(this._mounted=!0,this.islandModule({initialData:this.initialData,qs:this.qs.bind(this),qsa:this.qsa.bind(this),subscribe:this.subscribe.bind(this),island:this.island.bind(this),...g(this)}))}disconnectedCallback(){queueMicrotask(()=>{this.isConnected||(this._mounted=!1,this._dispose())})}},q=(r,e)=>{if(customElements.get(r))return;let t=s=>class extends b{constructor(){super(s)}connectedCallback(){this.hasAttribute("data-template")||super.connectedCallback()}};customElements.define(r,t(e))};var S=Symbol("stream.skip"),u=class r{constructor(e,t,s=!0){this.observer=e,this.internalValue=t,this.subscribers=new Set,this.initialNotify=s,this.queue=new Set,this.hasPendingUpdates=!1}_processQueue(){this.hasPendingUpdates=!1,this.queue.forEach(e=>e.next?.(this.get())),this.queue.clear()}get(){return this.internalValue}cleanup(){this.destroyFn?.(),this.subscribers.clear(),this.observerCalled=!1}subscribe(e,t=!1){let{next:s,error:o,complete:i}=e;s||typeof e=="function"&&(s=e),o||(o=()=>{}),i||(i=()=>{});let n={next:s,error:o,complete:i};return this.subscribers.add(n),!this.observerCalled&&this.observer&&(this.observerCalled=!0,this.destroyFn=this.observer({next:this.next.bind(this),error:this.error.bind(this),complete:this.complete.bind(this)})),(this.initialNotify||t)&&n.next?.(this.internalValue),()=>{this.subscribers.delete(n),this.subscribers.size<1&&this.destroyFn?.()}}_batch(){this.subscribers.forEach(e=>{this.queue.add(e),this.hasPendingUpdates||(this.hasPendingUpdates=!0,queueMicrotask(this._processQueue.bind(this)))})}error(e){this.subscribers.forEach(t=>{t.error(e)})}complete(){this.subscribers.forEach(e=>{e.complete()}),this.cleanup()}next(e){let t=e,s=this.get();typeof e=="function"&&(t=e(s)),!(!(e instanceof Node)&&Object.is(t,this.internalValue))&&(this.internalValue=t,this._batch())}pipe(...e){return new r(t=>{let s=this.subscribe({async next(o){let i=o;try{for(let n of e)if(i=await n(i,()=>S),i===S)return;t.next(i)}catch(n){console.error("Stream operator error:",n),t.error(n)}},error(o){console.error("Stream operator error from source stream!:",o),t.error(o)},complete(){t.complete()}});return()=>{s()}},this.get(),!1)}};var C=(r,e,{raf:t=!1,immediate:s=!1,...o}={})=>new u(i=>{let n=null,c=l=>{if(t){if(n)return;n=requestAnimationFrame(()=>{i.next(l),n=null})}else i.next(l)};return r.addEventListener(e,c,o),()=>{n&&(cancelAnimationFrame(n),n=null),r.removeEventListener(e,c,o)}},null,s);var k=r=>{let e=null;return new u(t=>(e=setInterval(()=>t.next(s=>s+1),r),()=>{e&&(clearInterval(e),e=null)}),0,!1)};var I=r=>{let e=null,t=()=>{e&&(clearTimeout(e),e=null)};return new u(s=>(e=setTimeout(()=>{s.next(!0),s.complete()},r),t),!1,!1)};var j=r=>new u(null,r,!0);var A=r=>{let e=[];if(r&&typeof r=="object")for(let[t,s]of Object.entries(r))e.push(`${encodeURIComponent(t)}=${encodeURIComponent(s)}`);return e.length?e.join("&"):""},M=(r,e={},t={})=>{let s,o=new u(null,{params:t,baseUrl:r,url:r,options:e},!0),i=o.pipe(async({params:n,url:c,options:l},m)=>{s?.abort(),s=new AbortController;try{let f=A(n);return await(await fetch(f?`${c}?${f}`:c,{...l,signal:s.signal})).json()}catch(f){return f.name==="AbortError"||o.error(f),m()}});return{pipe:i.pipe.bind(i),subscribe(n){return i.subscribe(n)},next(n){let c="",l=o.get()?.options??{},m=o.get()?.params??{},f=a=>{typeof a=="object"?(c=a.url??r,l=a?.options??l,m=a?.params?{...m,...a.params}:m):typeof a=="string"&&(c=a)};if(typeof n=="function"){let a=o.get();f(n(a))}else f(n);o.next({params:m,baseUrl:r,url:c,options:l})}}};var V=(...r)=>{let e=new u(null,null,!1),t=[],s=n=>c=>{t[n]=c,e.next([...t])},o=r.reduce((n,c,l)=>[...n,c.subscribe(s(l))],[]),i=e.subscribe.bind(e);return e.subscribe=n=>{let c=i(n);return()=>{c(),o.forEach(l=>{l()})}},e};var $=r=>{let e,t;return(s,o)=>(t?.(o()),e&&clearTimeout(e),new Promise(i=>{t=i,e=setTimeout(()=>{i(s),t=null},r)}))};var D=r=>async(e,t)=>await r(e)?e:t();var v=r=>async e=>await r(e);var T=r=>{let e=!0;return async t=>e?(e=!1,r):t};var F=r=>e=>(r(e),e);export{$ as debounce,D as filter,C as fromEvent,M as fromFetch,k as fromInterval,V as fromMerge,I as fromTimer,j as fromValue,q as island,v as map,T as startWith,F as tap};
